# Payroll System B 워크플로우 분석

> 급여명세서 자동 발송 시스템

## 📋 워크플로우 개요

### 기본 정보
- **워크플로우명**: 급여명세서 자동 발송 (Payroll B)
- **목적**: Google Drive에 업로드된 급여명세서 PDF를 직원별로 자동 매칭하여 이메일 발송
- **실행 주기**: 매일 14시 자동 실행 (파일 업로드 감지)
- **처리 방식**: 파일명 파싱 → HR DB 매칭 → 이메일 발송 → 로그 기록 → 파일 정리
- **연동 시스템**: Google Drive, Gmail, Notion HR DB

## 🏗 워크플로우 구조

### 전체 프로세스 플로우
```
매일 14시 트리거
    ↓
Google Drive에서 '급여명세서' PDF 파일 검색
    ↓
파일명 파싱 (직원명, 대상월 추출)
    ↓
Notion HR DB에서 해당 직원 정보 조회
    ↓
직원 정보 존재 여부 판단 (IF 분기)
    ↓
[성공 경로] PDF 다운로드 → 이메일 발송 → 성공 로그 → 완료폴더 이동
[실패 경로] 에러 알림 → 실패 로그 → 실패폴더 이동
```

## 🧠 핵심 로직: 파일명 파싱

### 지원하는 파일명 패턴 (5가지)
**패턴 1**: `직원명_급여명세서_YYYYMM.pdf`
- 예시: `홍길동_급여명세서_202507.pdf`
- 추출: 직원명 = "홍길동", 대상월 = "2025-07"

**패턴 2**: `급여명세서(근로기준1)_번호_직원명_YYYYMM.pdf`
- 예시: `급여명세서(근로기준1)_15_이사황_202506.pdf`
- 추출: 직원명 = "이사황", 대상월 = "2025-06"

**패턴 3**: `회사명(지점명)_YY년 MM월 직원명님 급여명세서.pdf`
- 예시: `이미커피(인사동)_25년 08월 김정훈님 급여명세서.pdf`
- 추출: 직원명 = "김정훈", 대상월 = "2025-08"

**패턴 4**: `회사명_YYYY년MM월_직원명_급여명세서.pdf`
- 예시: `이미커피_2024년12월_홍길동_급여명세서.pdf`
- 추출: 직원명 = "홍길동", 대상월 = "2024-12"

**패턴 5**: `YYYY-MM_직원명_급여명세서.pdf`
- 예시: `2024-12_홍길동_급여명세서.pdf`
- 추출: 직원명 = "홍길동", 대상월 = "2024-12"

### 파싱 로직 상세 (범용적 정규식 기반)
```javascript
// 5가지 패턴을 순차적으로 체크하여 매칭

// 패턴 1: "홍길동_급여명세서_202507.pdf"
const pattern1 = /^(.+?)_급여명세서_(\d{6})$/;
if (nameWithoutExtension.match(pattern1)) {
    // 직원명과 YYYYMM 형식 대상월 추출
}

// 패턴 3: "이미커피(인사동)_25년 08월 김정훈님 급여명세서.pdf"  
const pattern3 = /^.+?\(.+?\)_(\d{2})년\s*(\d{1,2})월\s*(.+?)님?\s*급여명세서$/;
if (nameWithoutExtension.match(pattern3)) {
    // YY년 → YYYY년 변환 (25년 → 2025년)
    // MM월 → MM 변환 (8월 → 08)
    // 직원명에서 '님' 제거
}

// try-catch로 에러 처리하여 워크플로우 중단 방지
// 매칭된 패턴 정보를 디버깅용으로 포함
```

## 👥 HR 데이터베이스 연동

### 직원 조회 조건
```sql
WHERE 재직상태 = '재직' 
AND 직원명 = '{파싱된 직원명}'
```

### 필수 정보 추출
- **이메일 주소**: 급여명세서 발송 대상
- **재직 상태**: 재직 중인 직원만 발송
- **직원명**: 파일명과 정확히 매칭되는지 검증

## 📧 이메일 발송 시스템

### 자동 생성되는 이메일 템플릿
**제목**: `[이미커피] YYYY-MM월 급여명세서 안내`

**본문**:
```
안녕하세요, {직원명}님.

{YYYY-MM}월 급여명세서를 첨부하여 보내드립니다.

내용 확인 후 문의사항이 있으시면 언제든지 연락 주세요.

감사합니다.

이미커피 관리팀
```

### 첨부파일
- 원본 PDF 급여명세서 (Google Drive에서 다운로드한 파일)

## 📊 로깅 및 추적 시스템

### Notion 로그 데이터베이스
**데이터베이스**: `[급여자동화] 발송 로그 DB`

**성공 로그 기록**:
| 필드 | 내용 | 예시 |
|------|------|------|
| 제목 | `YYYY-MM월 급여명세서 (직원명)` | `2024-07월 급여명세서 (홍길동)` |
| 발송상태 | `발송 완료` | Select 옵션 |
| 파일명 | 원본 파일명 | `홍길동_급여명세서_202507.pdf` |
| 대상월 | Notion Date 형식 | `2024-07-01` |

**실패 로그 기록**:
| 필드 | 내용 | 예시 |
|------|------|------|
| 제목 | `YYYY-MM월 급여명세서 (직원명) - 발송 실패` | `2024-07월 급여명세서 (홍길동) - 발송 실패` |
| 발송상태 | `발송 실패` | Select 옵션 |
| 파일명 | 원본 파일명 | `홍길동_급여명세서_202507.pdf` |

## 🔔 에러 처리 및 알림

### 에러 알림 시스템
**수신자**: `imiroasters@gmail.com` (관리자)
**제목**: `[알림] 급여명세서 발송 실패 - 직원 조회 오류`

**알림 내용**:
```
파일명: 홍길동_급여명세서_202507.pdf
추출된 이름: 홍길동
사유: 해당 이름의 재직 직원을 찾을 수 없습니다.

확인 후 조치 바랍니다.
```

### 주요 에러 케이스
1. **직원 정보 없음**: HR DB에서 해당 이름의 재직 직원을 찾을 수 없음
2. **이메일 주소 없음**: 직원 정보는 있지만 이메일 주소가 없음
3. **파일명 형식 오류**: 지원하지 않는 파일명 패턴
4. **파일 형식 오류**: PDF가 아닌 다른 형식의 파일

## 📁 파일 관리 시스템

### Google Drive 폴더 구조
```
급여명세서 업로드 폴더/
├── 처리대기/          # 새로 업로드된 파일들
├── 발송완료/          # 성공적으로 발송된 파일들 (1hz-D97uwOmS-_sEAfHl2LgU1Ffn1KOK2)
└── 발송실패/          # 발송에 실패한 파일들 (1H5QQpAJIeEoW2ENROG3QlEXALjNCXkTd)
```

### 자동 파일 정리
- **성공 시**: 발송완료 폴더로 이동
- **실패 시**: 발송실패 폴더로 이동
- **원본 보존**: 모든 파일이 적절한 폴더에 보관되어 추적 가능

## 📈 운영 성과 및 특징

### 자동화 효과
- **수동 작업 시간**: 파일당 5-10분 → 완전 자동화
- **실수 방지**: 파일명 파싱으로 정확한 매칭
- **즉시 발송**: 매일 14시에 자동 체크하여 신속한 처리
- **완전 추적**: 모든 발송 내역이 Notion에 기록

### 안정성 features
- **중복 발송 방지**: 이미 처리된 파일은 폴더 이동으로 제외
- **에러 복구**: 실패한 파일은 별도 폴더에 보관하여 재처리 가능
- **관리자 알림**: 모든 에러 상황에 대해 즉시 알림
- **상세 로깅**: 성공/실패 모든 케이스에 대한 상세 기록

## 🔧 기술적 특징

### 데이터 무결성
- **필수 필드 검증**: 직원명, 대상월, 이메일 주소 모두 검증
- **타입 안전성**: 파일 확장자, 날짜 형식 등 엄격한 검증
- **트랜잭션**: 이메일 발송 → 로그 기록 → 파일 이동 순서로 처리

### 확장성 고려
- **파일명 패턴**: 2가지 패턴 지원으로 다양한 노무사 시스템 대응
- **유연한 스케줄**: 트리거 시간 변경으로 처리 시점 조정 가능
- **모듈화**: 각 단계별 독립적 노드로 구성하여 유지보수 용이

## 🎯 Claude Code 연동 계획

### Phase 1: 파일명 인식 향상
- **`ai-business-architect`** 에이전트로 더 복잡한 파일명 패턴 학습
- 자연어 처리를 통한 유연한 파일명 파싱
- 오타나 변형된 직원명 자동 매칭

### Phase 2: 콘텐츠 개인화
- **`imi-work-youtube-blogger`** 에이전트로 개인별 맞춤 이메일 생성
- 직원별 근무 특성을 반영한 메시지 자동화
- 급여 관련 FAQ나 공지사항 자동 첨부

### Phase 3: 인사이트 생성
- **`premium-market-strategist`** 에이전트로 급여 발송 패턴 분석
- 직원별 급여명세서 확인 행동 분석
- 인사 관리 효율성 개선 방안 도출

## 🚀 개선 계획

### 단기 개선 (1-2주)
- [ ] 실패 파일 자동 재처리 로직 추가
- [ ] 이메일 템플릿 다국어 지원 (외국인 직원 대응)
- [ ] 발송 완료 후 SMS 알림 추가 (선택사항)

### 중기 개선 (1-2개월)
- [ ] 급여명세서 열람 확인 시스템 (읽음 확인)
- [ ] 개인별 발송 히스토리 대시보드
- [ ] 모바일 최적화된 이메일 템플릿

### 장기 개선 (3-6개월)
- [ ] AI 기반 개인별 맞춤 메시지 생성
- [ ] 급여 관련 문의 자동 응답 시스템
- [ ] 블록체인 기반 급여명세서 무결성 보장

## 📊 Payroll A와의 연동 효과

### 완전한 급여 생태계
- **Payroll A**: 변동사항 수집 → 노무사 전달 → 급여 계산
- **Payroll B**: 계산 완료된 급여명세서 → 직원 개별 발송
- **시너지**: 25일 변동사항 요청부터 급여명세서 발송까지 완전 자동화

### 데이터 연결성
- 동일한 HR DB 사용으로 일관된 직원 정보
- 월별 처리 사이클로 체계적인 급여 관리
- Notion 로그를 통한 전체 프로세스 추적

---

*Google Drive 파일 업로드만으로 급여명세서가 자동으로 직원들에게 발송되는 완전 자동화 시스템입니다. 파일명 파싱, HR DB 매칭, 이메일 발송, 로그 기록, 파일 정리까지 모든 과정이 무인으로 처리되어 관리자의 업무 부담을 획기적으로 줄여줍니다.*

## Related Notes

- [[40-personal/44-reflections/learning/git-repository-study-plan]] - ai_automation 관련; 20-operations ↔ 40-personal 연결
- [[40-personal/44-reflections/learning/ab-method-philosophy]] - ai_automation 관련; 20-operations ↔ 40-personal 연결
- [[00-inbox/2025-08-30]] - ai_automation 관련; 20-operations ↔ 00-inbox 연결
- [[30-knowledge/31-business/31.01-imi/hr/이미 커피 직원/직원-관리-DB]] - ai_automation 관련; 20-operations ↔ 30-knowledge 연결
- [[40-personal/41-daily/2025-10-09]] - ai_automation 관련; 20-operations ↔ 40-personal 연결
